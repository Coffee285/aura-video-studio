<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Electron Process and Window Lifecycle Hardening | Aura Video Studio </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Electron Process and Window Lifecycle Hardening | Aura Video Studio ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.html">
      <meta name="docfx:tocrel" content="../../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/Coffee285/aura-video-studio/blob/main/docs/architecture/ELECTRON_PROCESS_LIFECYCLE_HARDENING.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo.svg" alt="Aura Video Studio">
            Aura Video Studio
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">

      <div class="content">
        <div class="actionbar">

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="electron-process-and-window-lifecycle-hardening">Electron Process and Window Lifecycle Hardening</h1>

<h2 id="summary">Summary</h2>
<p>Comprehensive hardening of Electron process management, window lifecycle, and child process cleanup to prevent orphaned processes.</p>
<h2 id="issues-found-and-fixed">Issues Found and Fixed</h2>
<h3 id="1--enhanced-process-termination-logging">1. ✅ Enhanced Process Termination Logging</h3>
<p><strong>Issue</strong>: Process termination commands lacked detailed logging, making it difficult to diagnose shutdown issues.</p>
<p><strong>Fix</strong>: Added comprehensive logging with:</p>
<ul>
<li>Process PID tracking</li>
<li>Command execution logging</li>
<li>Success/failure status</li>
<li>Error code handling</li>
<li>Timeout protection</li>
</ul>
<p><strong>Files Modified</strong>:</p>
<ul>
<li><code>Aura.Desktop/electron/backend-service.js</code> - Enhanced <code>_windowsTerminate()</code> logging</li>
<li><code>Aura.Desktop/electron/process-manager.js</code> - Enhanced <code>_windowsTerminate()</code> logging</li>
</ul>
<h3 id="2--improved-failsafe-process-termination-safety">2. ✅ Improved Failsafe Process Termination Safety</h3>
<p><strong>Issue</strong>: The failsafe process termination could potentially kill system-wide processes.</p>
<p><strong>Fix</strong>:</p>
<ul>
<li>Windows: Exclude Electron's own PID from termination</li>
<li>Unix: Use <code>-P</code> flag to only kill children of current process</li>
<li>Removed <code>dotnet.exe</code> from patterns (too broad)</li>
<li>Added better error handling and logging</li>
<li>Added timeout protection</li>
</ul>
<p><strong>File</strong>: <code>Aura.Desktop/electron/shutdown-orchestrator.js</code></p>
<h2 id="verified-components">Verified Components</h2>
<h3 id="backend-process-management-">Backend Process Management ✅</h3>
<ul>
<li><strong>Graceful Shutdown</strong>: Backend service attempts graceful shutdown via API first</li>
<li><strong>Process Tree Termination</strong>: Uses <code>taskkill /T</code> on Windows to kill entire process tree</li>
<li><strong>Timeout Protection</strong>: 5-second timeout on process termination commands</li>
<li><strong>Fallback Handling</strong>: Falls back to Node's <code>process.kill()</code> if taskkill fails</li>
<li><strong>Error Handling</strong>: Properly handles &quot;process already exited&quot; cases</li>
</ul>
<h3 id="ffmpeg-process-management-">FFmpeg Process Management ✅</h3>
<ul>
<li><strong>.NET Backend</strong>: FFmpeg processes tracked in <code>ProcessManager</code> with <code>entireProcessTree: true</code></li>
<li><strong>Cancellation</strong>: FFmpeg processes terminated when render jobs are cancelled</li>
<li><strong>Shutdown</strong>: All FFmpeg processes terminated during backend shutdown</li>
<li><strong>Timeout</strong>: 30-minute timeout on FFmpeg renders with automatic termination</li>
</ul>
<h3 id="process-manager-integration-">Process Manager Integration ✅</h3>
<ul>
<li><strong>Centralized Tracking</strong>: All child processes registered with <code>ProcessManager</code></li>
<li><strong>Shutdown Integration</strong>: <code>ProcessManager.terminateAll()</code> called during shutdown</li>
<li><strong>Graceful Termination</strong>: Attempts graceful termination before force kill</li>
<li><strong>Timeout Protection</strong>: Configurable timeouts for process termination</li>
</ul>
<h3 id="window-lifecycle-">Window Lifecycle ✅</h3>
<ul>
<li><strong>Window Close Handler</strong>: Properly handles window close events</li>
<li><strong>Minimize to Tray</strong>: On Windows, closes minimize to tray instead of quitting</li>
<li><strong>Shutdown Orchestrator</strong>: Coordinates window closing during shutdown</li>
<li><strong>Window Cleanup</strong>: All windows properly closed before app quit</li>
</ul>
<h3 id="shutdown-sequence-">Shutdown Sequence ✅</h3>
<p>The shutdown sequence is well-orchestrated:</p>
<ol>
<li>Check for active renders (with user confirmation)</li>
<li>Close windows gracefully</li>
<li>Signal backend to shutdown via API</li>
<li>Stop backend service</li>
<li>Terminate all tracked child processes (via ProcessManager)</li>
<li>Cleanup temporary files</li>
<li>Failsafe: Kill all Aura processes by name (last resort)</li>
</ol>
<h2 id="safety-features">Safety Features</h2>
<h3 id="process-termination-safety">Process Termination Safety</h3>
<ul>
<li>✅ Only kills processes that are children of our backend</li>
<li>✅ Excludes Electron's own PID from termination</li>
<li>✅ Handles &quot;process already exited&quot; gracefully</li>
<li>✅ Timeout protection on all termination commands</li>
<li>✅ Fallback mechanisms if primary termination fails</li>
</ul>
<h3 id="error-handling">Error Handling</h3>
<ul>
<li>✅ Comprehensive error logging</li>
<li>✅ Error code checking (128 = process not found on Windows)</li>
<li>✅ Graceful degradation if termination fails</li>
<li>✅ Failsafe activation if normal shutdown fails</li>
</ul>
<h3 id="resource-cleanup">Resource Cleanup</h3>
<ul>
<li>✅ Backend process tree terminated</li>
<li>✅ FFmpeg processes terminated</li>
<li>✅ SSE connections closed</li>
<li>✅ Temporary files cleaned up</li>
<li>✅ System tray destroyed</li>
</ul>
<h2 id="best-practices-implemented">Best Practices Implemented</h2>
<ol>
<li><strong>Graceful First</strong>: Always attempt graceful shutdown before force kill</li>
<li><strong>Process Tree</strong>: Use <code>/T</code> flag on Windows to kill entire process tree</li>
<li><strong>Timeout Protection</strong>: All async operations have timeouts</li>
<li><strong>Comprehensive Logging</strong>: All process operations are logged</li>
<li><strong>Failsafe Mechanisms</strong>: Multiple layers of cleanup</li>
<li><strong>Error Recovery</strong>: Fallback mechanisms at every level</li>
</ol>
<h2 id="conclusion">Conclusion</h2>
<p>The Electron process and window lifecycle management is <strong>robust and well-hardened</strong>. All critical processes (backend, FFmpeg) are properly tracked and terminated. The shutdown sequence is comprehensive with multiple safety mechanisms. Enhanced logging makes it easier to diagnose any issues.</p>
<h2 id="files-modified">Files Modified</h2>
<ol>
<li><p><code>Aura.Desktop/electron/backend-service.js</code></p>
<ul>
<li>Enhanced <code>_windowsTerminate()</code> with better logging and error handling</li>
<li>Added timeout protection</li>
<li>Improved fallback handling</li>
</ul>
</li>
<li><p><code>Aura.Desktop/electron/process-manager.js</code></p>
<ul>
<li>Enhanced <code>_windowsTerminate()</code> with better logging</li>
<li>Added timeout protection</li>
<li>Improved error code handling</li>
</ul>
</li>
<li><p><code>Aura.Desktop/electron/shutdown-orchestrator.js</code></p>
<ul>
<li>Improved failsafe process termination safety</li>
<li>Better error handling and logging</li>
<li>Removed overly broad process patterns</li>
</ul>
</li>
</ol>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/Coffee285/aura-video-studio/blob/main/docs/architecture/ELECTRON_PROCESS_LIFECYCLE_HARDENING.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          © 2025 Aura Video Studio. Documentation built with DocFX.
        </div>
      </div>
    </footer>
  </body>
</html>
