# WAV Merger Fix - Summary

## Problem Statement

FFmpeg was failing to read WAV files generated by the Windows TTS provider with the error:
```
Error opening input file C:\Users\User\AppData\Local\Temp\AuraVideoStudio\TTS\narration_20251012192303.wav.
Error opening input files: Invalid data found when processing input
```

Exit code: `-1094995529` (FFmpeg crash)

## Root Cause

The `WavMerger` class was hardcoding a file position of 44 bytes when seeking to the audio data in WAV files:

```csharp
// Old code (line 50 in WavMerger.cs)
segmentReader.BaseStream.Seek(44, SeekOrigin.Begin);
```

This assumption is **incorrect** because:

1. **Standard WAV files** typically have 44 bytes of header (RIFF + WAVE + fmt + data headers)
2. **Windows TTS-generated WAV files** often include additional metadata chunks (like LIST, INFO, etc.) between the fmt and data chunks
3. These extra chunks increase the header size beyond 44 bytes
4. Seeking to position 44 would skip past important header data and start reading from the middle of metadata chunks, producing corrupted audio data

## Solution

Modified `WavMerger.cs` to properly track the data chunk position:

### Before:
```csharp
// Skip header
segmentReader.BaseStream.Seek(44, SeekOrigin.Begin);
```

### After:
```csharp
// Read header to position at data start
var segmentHeader = ReadWavHeader(segmentReader);
// Now we're positioned right at the start of the audio data
```

The `ReadWavHeader` method already correctly navigates through all chunks to find the "data" chunk, leaving the stream position at the exact start of the audio data. By reusing this method for each segment, we ensure correct positioning regardless of extra metadata.

## Changes Made

### 1. `Aura.Providers/Audio/WavMerger.cs`
- **Changed:** Replaced hardcoded `Seek(44, ...)` with call to `ReadWavHeader()` for each segment
- **Why:** Ensures correct positioning at the start of audio data, regardless of metadata chunks
- **Lines affected:** 41-43

### 2. `Aura.Tests/WavMergerTests.cs`
- **Added:** New test `MergeWavFiles_Should_HandleWavWithExtraChunks()` 
- **Added:** Helper method `CreateTestWavWithMetadata()` to generate WAV files with LIST chunks
- **Why:** Validates the fix works with WAV files containing metadata (like Windows TTS generates)
- **Lines added:** 56 lines

## Test Results

All tests pass successfully:

```
✓ Aura.Tests.WavMergerTests.MergeWavFiles_Should_CreateValidOutput
✓ Aura.Tests.WavMergerTests.MergeWavFiles_Should_HandleTimingGaps  
✓ Aura.Tests.WavMergerTests.MergeWavFiles_Should_HandleWavWithExtraChunks (NEW)

Total WavMerger tests: 3/3 passed
Total TTS Provider tests: 22/22 passed
Total solution tests: 644/644 passed
```

## Impact

This fix resolves:
1. **FFmpeg failures** when processing Windows TTS-generated WAV files
2. **Video generation failures** that occurred after TTS synthesis
3. **Compatibility issues** with WAV files containing metadata chunks

The fix is **backward compatible** - it works with both:
- Simple 44-byte header WAV files (like those created by MockTtsProvider)
- Complex WAV files with additional metadata chunks (like Windows TTS)

## Technical Details

### WAV File Structure

**Standard WAV (44-byte header):**
```
[RIFF][size][WAVE][fmt ][16][format data...][data][size][audio data...]
 0-3   4-7   8-11 12-15  16-19  20-35       36-39 40-43  44+
```

**WAV with metadata (variable header):**
```
[RIFF][size][WAVE][fmt ][16][format data...][LIST][size][metadata...][data][size][audio data...]
 0-3   4-7   8-11 12-15  16-19  20-35       36-39 40-43  44-???       ???   ???+4  ???+8+
```

The `ReadWavHeader` method correctly handles both cases by:
1. Reading the RIFF and WAVE identifiers
2. Reading the fmt chunk
3. **Skipping any unknown chunks** (LIST, INFO, etc.)
4. Finding the data chunk
5. Leaving the stream position at the start of audio data

## Verification

To verify the fix works:

1. **Unit tests:** Run `dotnet test --filter "FullyQualifiedName~WavMerger"`
2. **Integration tests:** Run `dotnet test --filter "FullyQualifiedName~TtsProvider"`  
3. **Manual testing:** 
   - Use Windows TTS to generate a video
   - Verify FFmpeg successfully reads the merged WAV file
   - Verify video generation completes without errors

## Related Files

- `Aura.Providers/Audio/WavMerger.cs` - Core WAV merging logic
- `Aura.Providers/Tts/WindowsTtsProvider.cs` - Generates WAV files with WavMerger
- `Aura.Providers/Video/FfmpegVideoComposer.cs` - Consumes merged WAV files
- `Aura.Tests/WavMergerTests.cs` - Unit tests for WAV merging
- `Aura.Tests/TtsProviderTests.cs` - Integration tests for TTS providers

## Future Improvements

While this fix resolves the immediate issue, potential improvements include:

1. **Return data position from ReadWavHeader:** Could make the API more explicit by returning the data position
2. **Support for more WAV formats:** Currently only supports 16-bit PCM; could add support for 24-bit, float, etc.
3. **Better error messages:** Could provide more detailed diagnostics when WAV files are corrupted
4. **Performance optimization:** Could avoid reading headers twice by caching format information

## Conclusion

This fix resolves a critical issue where Windows TTS-generated WAV files could not be processed by FFmpeg, causing video generation to fail. The solution properly handles WAV files with variable header sizes by using the existing header parsing logic instead of hardcoding file positions.

The fix is minimal, surgical, and fully backward compatible with existing code.
